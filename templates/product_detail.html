<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ product.name }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        /* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø®Ø§ØµØ© Ø¨Ø§Ù„ØªÙ‚ÙŠÙŠÙ… */
        .rating-stars {
            color: gold;
            font-size: 1.5em;
        }
        .rating-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
        .review-list {
            margin-top: 30px;
            border-top: 1px solid #eee;
            padding-top: 20px;
        }
        .review-item {
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 6px;
        }
    </style>
</head>
<body>
    <header>
        <h1>{{ product.name }}</h1>
        <a href="{{ url_for('home') }}" class="admin-link">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…ØªØ¬Ø±</a>
        <span style="margin-left:12px;">
            <a href="{{ url_for('set_currency', currency_code='USD') }}">USD</a> |
            <a href="{{ url_for('set_currency', currency_code='SAR') }}">Ø±ÙŠØ§Ù„</a>
        </span>
    </header>

    <main>
        <section class="product-detail-container">
            <img src="{{ product.image_url }}" alt="{{ product.name }}" onerror="this.src='{{ url_for('static', filename='placeholder.png') }}'" class="detail-image">
            
            <div class="product-info">
                <h2>{{ product.name }}</h2>
                <p class="price-large">Ø§Ù„Ø³Ø¹Ø±: <strong>{{ format_price(product.price) }}</strong></p>
                
                <div class="rating-display">
                    <span class="rating-stars">
                        {# Ø¹Ø±Ø¶ Ø§Ù„Ù†Ø¬ÙˆÙ… Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù…ØªÙˆØ³Ø· Ø§Ù„ØªÙ‚ÙŠÙŠÙ… #}
                        {% set full_stars = rating_info.average | round | int %}
                        {% for i in range(full_stars) %}â˜…{% endfor %}
                        {% for i in range(5 - full_stars) %}â˜†{% endfor %}
                    </span>
                    ({{ rating_info.average | round(2) }}) Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ {{ rating_info.count }} ØªÙ‚ÙŠÙŠÙ….
                </div>
                
                <p><strong>Ø§Ù„ÙˆØµÙ:</strong> {{ product.description }}</p>
                <p><strong>Ø§Ù„ÙØ¦Ø©:</strong> {{ product.category.name if product.category else 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}</p>
                <p><strong>Ø§Ù„Ù…Ø®Ø²ÙˆÙ†:</strong> 
                    {% if product.stock > 0 %}
                        Ù…ØªÙˆÙØ±: {{ product.stock }}
                    {% else %}
                        <span style="color: red;">Ù†ÙØ¯ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</span>
                    {% endif %}
                </p>

                {% if product.stock > 0 %}
                    <button onclick="addToCart({{ product.id }})" style="background-color: #007bff; margin-top: 20px;">
                        ğŸ›’ Ø£Ø¶Ù Ø¥Ù„Ù‰ Ø§Ù„Ø³Ù„Ø©
                    </button>
                {% endif %}
            </div>
        </section>

        <section class="review-section">
            <h2>ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h2>

            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="message-{{ category }}">{{ message }}</div>
                    {% endfor %}
                {% endif %}
            {% endwith %}

            <div class="rating-form">
                <h3>Ø£Ø¶Ù ØªÙ‚ÙŠÙŠÙ…Ùƒ</h3>
                <form method="POST" action="{{ url_for('submit_review', product_id=product.id) }}">
                    <label for="reviewer_name">Ø§Ø³Ù…Ùƒ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
                    <input type="text" id="reviewer_name" name="reviewer_name" placeholder="Ø§Ø³Ù…Ùƒ">

                    <label for="rating">Ø§Ù„ØªÙ‚ÙŠÙŠÙ… (1-5 Ù†Ø¬ÙˆÙ…):</label>
                    <select id="rating" name="rating" required>
                        <option value="">Ø§Ø®ØªØ± ØªÙ‚ÙŠÙŠÙ…...</option>
                        <option value="5">5 Ù†Ø¬ÙˆÙ… - Ù…Ù…ØªØ§Ø²</option>
                        <option value="4">4 Ù†Ø¬ÙˆÙ… - Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹</option>
                        <option value="3">3 Ù†Ø¬ÙˆÙ… - Ù…ØªÙˆØ³Ø·</option>
                        <option value="2">2 Ù†Ø¬ÙˆÙ… - Ø³ÙŠØ¦</option>
                        <option value="1">1 Ù†Ø¬Ù…Ø© - Ø³ÙŠØ¦ Ø¬Ø¯Ø§Ù‹</option>
                    </select>

                    <label for="comment">Ù…Ø±Ø§Ø¬Ø¹ØªÙƒ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
                    <textarea id="comment" name="comment" rows="4"></textarea>

                    <button type="submit">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</button>
                </form>
            </div>
            
            <div class="review-list">
                <h3>Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø§Øª ({{ reviews|length }})</h3>
                {% for review in reviews %}
                    <div class="review-item">
                        <p>
                            <span class="rating-stars">
                                {# Ø¹Ø±Ø¶ Ø§Ù„Ù†Ø¬ÙˆÙ… Ù„Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„ÙØ±Ø¯ÙŠ #}
                                {% for i in range(review.rating) %}â˜…{% endfor %}
                                {% for i in range(5 - review.rating) %}â˜†{% endfor %}
                            </span>
                            <span style="margin-left: 10px; font-weight: bold;">{{ review.rating }} / 5</span>
                        </p>
                        <p><strong>Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹:</strong> {{ review.reviewer_name }}</p>
                        <p><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> {{ review.date_posted }}</p>
                        {% if review.comment %}
                            <p>{{ review.comment }}</p>
                        {% endif %}
                    </div>
                {% else %}
                    <p>Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ø¹Ø¯. ÙƒÙ† Ø£ÙˆÙ„ Ù…Ù† ÙŠÙ‚ÙŠÙ‘Ù…Ù‡!</p>
                {% endfor %}
            </div>
        </section>
    </main>
    
    <script>
        async function addToCart(productId) {
            try {
                const response = await fetch(`/cart/add/${productId}`);
                const data = await response.json();
                
                if (response.ok) {
                    alert(data.message);
                    // ÙŠÙ…ÙƒÙ†Ùƒ ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø³Ù„Ø© Ù‡Ù†Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©
                } else {
                    alert(`ÙØ´Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙØ©: ${data.message}`);
                }

            } catch (error) {
                console.error('Error adding to cart:', error);
                alert('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù… Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬.');
            }
        }
    </script>
</body>
</html>
