<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ููุญุฉ ุฅุฏุงุฑุฉ ุงููุชุฌุฑ</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        /* ... (ุชูุณููุงุช CSS ุงูุณุงุจูุฉ ููุง ูู) ... */
        .admin-section {
            background: white;
            padding: 20px;
            margin-bottom: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        /* ... (ุฃุถู ุฃู ุชูุณููุงุช ุฌุฏูุฏุฉ ููุง) ... */
    </style>
</head>
<body>
    <header class="admin-header">
        <h1>ููุญุฉ ุฅุฏุงุฑุฉ ุงููุชุฌุฑ</h1>
        <div>
            <span style="color: white; margin-left: 15px;">ูุฑุญุจุงูุ {{ session.get('username', 'ูุดุฑู') }}</span>
            <a href="{{ url_for('home') }}" class="admin-link">ุงูุนูุฏุฉ ูููุชุฌุฑ</a>
            <a href="{{ url_for('admin_logout') }}">ุชุณุฌูู ุงูุฎุฑูุฌ</a>
        </div>
    </header>

    <main>
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="message-{{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <section class="admin-section dashboard-stats">
            <div class="stat-card">
                <h3>๐ฐ ุฅุฌูุงูู ุงููุจูุนุงุช ุงูููุชููุฉ</h3>
                <p>${{ stats.total_sales | round(2) }}</p>
            </div>
            <div class="stat-card">
                <h3>๐ ุงูุทูุจุงุช ุงูุฌุฏูุฏุฉ</h3>
                <p style="color: {% if stats.new_orders_count > 0 %}#ffc107{% else %}#28a745{% endif %};">
                    {{ stats.new_orders_count }}
                </p>
            </div>
            <div class="stat-card {% if stats.low_stock_count > 0 %}alert{% endif %}">
                <h3>โ๏ธ ููุชุฌุงุช ููููุฉ ุงููุฎุฒูู</h3>
                <p>{{ stats.low_stock_count }}</p>
            </div>
        </section>

        {% if low_stock_products %}
        <section class="admin-section" style="background-color: #fff3cd; border: 1px solid #ffeeba; color: #856404;">
            <h3>ุชูุจูู ุงููุฎุฒูู ุงูููุฎูุถ</h3>
            <p>ุงูููุชุฌุงุช ุงูุชุงููุฉ ุชุญุชุงุฌ ุฅูู ุฅุนุงุฏุฉ ุชุฒููุฏ ุจุงููุฎุฒูู (ุงููุฎุฒูู 5 ุฃู ุฃูู):</p>
            <ul>
                {% for product in low_stock_products %}
                    <li>**{{ product.name }}** (ุงููุฎุฒูู ุงููุชุจูู: {{ product.stock }})</li>
                {% endfor %}
            </ul>
        </section>
        {% endif %}

        <hr>

        {% if permissions.admins %}
        <section class="admin-section">
            <h2>๐ค ุฅุฏุงุฑุฉ ุงููุดุฑููู ูุงูุตูุงุญูุงุช</h2>
            
            <h3>ุฅุถุงูุฉ ูุดุฑู ุฌุฏูุฏ</h3>
            <form method="POST" action="{{ url_for('add_admin') }}" style="display: flex; flex-direction: column; gap: 10px; padding: 15px; border: 1px dashed #ccc; margin-bottom: 20px;">
                <input type="text" name="username" placeholder="ุงุณู ุงููุดุฑู ุงูุฌุฏูุฏ" required style="padding: 10px;">
                <input type="password" name="password" placeholder="ูููุฉ ุงููุฑูุฑ" required style="padding: 10px;">
                
                <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-top: 10px;">
                    <label><input type="checkbox" name="products"> ุฅุฏุงุฑุฉ ุงูููุชุฌุงุช</label>
                    <label><input type="checkbox" name="orders"> ุฅุฏุงุฑุฉ ุงูุทูุจุงุช</label>
                    <label><input type="checkbox" name="reviews"> ุฅุฏุงุฑุฉ ุงูุชููููุงุช</label>
                    <label><input type="checkbox" name="admins"> ุฅุฏุงุฑุฉ ุงููุดุฑููู (ูุงูู ุงูุตูุงุญูุงุช)</label>
                </div>

                <button type="submit" style="background-color: #007bff; color: white;">ุฅุถุงูุฉ ุงููุดุฑู</button>
            </form>
            
            <h3>ูุงุฆูุฉ ุงููุดุฑููู ุงูุญุงูููู</h3>
            <table>
                <thead>
                    <tr>
                        <th>ุงูุงุณู</th>
                        <th>ุงูููุชุฌุงุช</th>
                        <th>ุงูุทูุจุงุช</th>
                        <th>ุงูุชููููุงุช</th>
                        <th>ุงููุดุฑููู</th>
                        <th>ุงูุฅุฌุฑุงุก</th>
                    </tr>
                </thead>
                <tbody>
                    {% for admin in admin_users %}
                    <tr>
                        <td>{{ admin.username }} {% if admin.id == session.get('admin_id') %}(ุฃูุช){% endif %}</td>
                        <td>
                            <input type="checkbox" class="perm-checkbox" data-user-id="{{ admin.id }}" data-perm-type="products" {% if admin.can_manage_products %}checked{% endif %} {% if admin.id == session.get('admin_id') %}disabled{% endif %}>
                        </td>
                        <td>
                            <input type="checkbox" class="perm-checkbox" data-user-id="{{ admin.id }}" data-perm-type="orders" {% if admin.can_manage_orders %}checked{% endif %} {% if admin.id == session.get('admin_id') %}disabled{% endif %}>
                        </td>
                        <td>
                            <input type="checkbox" class="perm-checkbox" data-user-id="{{ admin.id }}" data-perm-type="reviews" {% if admin.can_manage_reviews %}checked{% endif %} {% if admin.id == session.get('admin_id') %}disabled{% endif %}>
                        </td>
                        <td>
                            <input type="checkbox" class="perm-checkbox" data-user-id="{{ admin.id }}" data-perm-type="admins" {% if admin.can_manage_admins %}checked{% endif %} {% if admin.id == session.get('admin_id') %}disabled{% endif %}>
                        </td>
                        <td>
                            {% if admin.id != session.get('admin_id') %}
                                <button style="background-color: #dc3545; padding: 6px 10px; opacity: 0.5;" disabled>ุญุฐู</button>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </section>
        <hr>
        {% endif %}
        {% if permissions.products %}
        <section class="admin-section">
            <h2>โ ุฅุถุงูุฉ ููุชุฌ ุฌุฏูุฏ</h2>
            <form method="POST" action="{{ url_for('add_product') }}" enctype="multipart/form-data">
                
                <div class="form-container" style="box-shadow: none;">
                    <label for="name">ุงุณู ุงูููุชุฌ:</label>
                    <input type="text" id="name" name="name" required>
                    <label for="price">ุงูุณุนุฑ ($):</label>
                    <input type="number" id="price" name="price" step="0.01" required>

                    <label for="stock">ุฑุตูุฏ ุงููุฎุฒูู:</label>
                    <input type="number" id="stock" name="stock" required>
                    
                    <label for="category_id">ุงููุฆุฉ:</label>
                    <select id="category_id" name="category_id" required>
                        {% for category in categories %}
                            <option value="{{ category.id }}">{{ category.name }}</option>
                        {% endfor %}
                    </select>

                    <label for="image_file">ุชุญููู ุตูุฑุฉ ุงูููุชุฌ:</label>
                    <input type="file" id="image_file" name="image_file" accept=".png, .jpg, .jpeg, .gif">

                    <label for="description">ุงููุตู:</label>
                    <textarea id="description" name="description"></textarea>
                    
                    <button type="submit">ุฃุถู ุงูููุชุฌ</button>
                </div>
            </form>
        </section>
        <hr>
        {% endif %}

        {% if permissions.products %}
        <section class="admin-section">
            <h2>๐ ุงูููุชุฌุงุช ุงูุญุงููุฉ ({{ products|length }})</h2>
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>ุงูุตูุฑุฉ</th>
                        <th>ุงูุงุณู</th>
                        <th>ุงูุณุนุฑ ($)</th>
                        <th>ุงููุฎุฒูู</th>
                        <th>ุงููุฆุฉ</th>
                        <th>ูุชูุณุท ุงูุชูููู</th>
                        <th>ุงูุฅุฌุฑุงุกุงุช</th>
                    </tr>
                </thead>
                <tbody>
                    {% for product in products %}
                        <tr>
                            <td>{{ product.id }}</td>
                            <td><img src="{{ product.image_url }}" alt="{{ product.name }}" onerror="this.src='/static/placeholder.png'"></td>
                            <td>{{ product.name }}</td>
                            <td>{{ product.price | round(2) }}</td>
                            <td style="color: {% if product.stock <= 5 %}red; font-weight: bold;{% endif %}">{{ product.stock }}</td>
                            <td>{{ product.category.name if product.category else 'ุบูุฑ ูุญุฏุฏ' }}</td>
                            
                            <td>
                                {% set rating_info = product.get_rating_info() %}
                                {% if rating_info.count > 0 %}
                                    <span class="rating-display">
                                        {{ rating_info.average | round(2) }} โญ
                                    </span>
                                    ({{ rating_info.count }})
                                {% else %}
                                    ูุง ููุฌุฏ ุชูููู
                                {% endif %}
                            </td>
                            
                            <td class="action-btns">
                                <a href="{{ url_for('edit_product', product_id=product.id) }}" style="background-color: #ffc107; color: #333;">ุชุนุฏูู</a>
                                
                                <form method="POST" action="{{ url_for('delete_product', product_id=product.id) }}" onsubmit="return confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ุงูููุชุฌ {{ product.name }}ุ');">
                                    <button type="submit" style="background-color: #dc3545;">ุญุฐู</button>
                                </form>
                                
                                <form method="POST" action="{{ url_for('reset_product_reviews', product_id=product.id) }}" onsubmit="return confirm('ุชุญุฐูุฑ! ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ุฌููุน ุชููููุงุช {{ product.name }}ุ');" style="display: inline;">
                                    <button type="submit" style="background-color: #ff9800; color: white;">ุฅุนุงุฏุฉ ุชุนููู ุงูุชูููู</button>
                                </form>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </section>
        <hr>
        {% endif %}

        {% if permissions.reviews %}
        <section class="admin-section">
            <h2>โญ ุฅุฏุงุฑุฉ ููุฑุงุฌุนุฉ ุงูุชููููุงุช ({{ all_reviews|length }})</h2>
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>ุงูููุชุฌ</th>
                        <th>ุงูุชูููู</th>
                        <th>ุงููุฑุงุฌุน</th>
                        <th>ุงูุชุนููู</th>
                        <th>ุงูุชุงุฑูุฎ</th>
                        <th>ุงูุฅุฌุฑุงุก</th>
                    </tr>
                </thead>
                <tbody>
                    {% for review in all_reviews %}
                        <tr>
                            <td>{{ review.id }}</td>
                            <td><a href="{{ url_for('product_detail', product_id=review.product_id) }}" target="_blank">{{ review.product.name }}</a></td>
                            <td>
                                <span class="rating-display">
                                    {% for i in range(review.rating) %}โ{% endfor %}
                                </span>
                                ({{ review.rating }}/5)
                            </td>
                            <td>{{ review.reviewer_name }}</td>
                            <td class="review-comment">{{ review.comment or '---' }}</td>
                            <td>{{ review.date_posted.strftime('%Y-%m-%d') }}</td>
                            <td>
                                <form method="POST" action="{{ url_for('delete_review', review_id=review.id) }}" onsubmit="return confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐุง ุงูุชููููุ');">
                                    <button type="submit" style="background-color: #dc3545;">ุญุฐู</button>
                                </form>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </section>
        <hr>
        {% endif %}

        {% if permissions.products %}
        <section class="admin-section">
            <h2>๐ท๏ธ ุฅุฏุงุฑุฉ ุงููุฆุงุช</h2>
            <form method="POST" action="{{ url_for('add_category') }}" style="display: flex; gap: 10px; margin-bottom: 20px;">
                <input type="text" name="name" placeholder="ุงุณู ุงููุฆุฉ ุงูุฌุฏูุฏุฉ" required style="flex-grow: 1; padding: 10px;">
                <button type="submit">ุฅุถุงูุฉ ูุฆุฉ</button>
            </form>
            
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>ุงูุงุณู</th>
                        <th>ุนุฏุฏ ุงูููุชุฌุงุช</th>
                        <th>ุงูุฅุฌุฑุงุก</th>
                    </tr>
                </thead>
                <tbody>
                    {% for category in categories %}
                        <tr>
                            <td>{{ category.id }}</td>
                            <td>{{ category.name }}</td>
                            <td>{{ category.products|length }}</td>
                            <td>
                                <form method="POST" action="{{ url_for('delete_category', category_id=category.id) }}" style="display: inline;" onsubmit="return confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ุงููุฆุฉุ');">
                                    <button type="submit" style="background-color: #dc3545;">ุญุฐู</button>
                                </form>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </section>
        <hr>
        {% endif %}

        {% if permissions.orders %}
        <section class="admin-section">
            <h2>๐ฆ ุงูุทูุจุงุช ุงูุญุฏูุซุฉ ({{ orders|length }})</h2>
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>ุงูุนููู</th>
                        <th>ุงูุฅุฌูุงูู ($)</th>
                        <th>ุงูุชุงุฑูุฎ</th>
                        <th>ุงูุญุงูุฉ</th>
                        <th>ุงูุฅุฌุฑุงุกุงุช</th>
                    </tr>
                </thead>
                <tbody>
                    {% for order in orders %}
                        <tr>
                            <td>{{ order.id }}</td>
                            <td>{{ order.customer_name }}</td>
                            <td>{{ order.total_price | round(2) }}</td>
                            <td>{{ order.date_placed.strftime('%Y-%m-%d %H:%M') }}</td>
                            <td>
                                <form method="POST" action="{{ url_for('update_order_status', order_id=order.id) }}" style="display: inline;">
                                    <select name="status" onchange="this.form.submit()">
                                        <option value="New" {% if order.status == 'New' %}selected{% endif %}>ุฌุฏูุฏ</option>
                                        <option value="Processing" {% if order.status == 'Processing' %}selected{% endif %}>ููุฏ ุงููุนุงูุฌุฉ</option>
                                        <option value="Shipped" {% if order.status == 'Shipped' %}selected{% endif %}>ุชู ุงูุดุญู</option>
                                        <option value="Delivered" {% if order.status == 'Delivered' %}selected{% endif %}>ุชู ุงูุชุณููู</option>
                                    </select>
                                </form>
                            </td>
                            <td>
                                <a href="{{ url_for('order_details', order_id=order.id) }}" style="background-color: #17a2b8;">ุชูุงุตูู</a>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </section>
        <hr>
        {% endif %}
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const checkboxes = document.querySelectorAll('.perm-checkbox');
            
            checkboxes.forEach(checkbox => {
                if (!checkbox.disabled) { // ูุง ุชุดุบู ุงููุณุชูุน ูููุดุฑู ุงูุญุงูู
                    checkbox.addEventListener('change', function() {
                        const userId = this.getAttribute('data-user-id');
                        const permType = this.getAttribute('data-perm-type');
                        const isChecked = this.checked;
                        
                        const url = `/admin/permission/toggle/${userId}/${permType}`;
                        
                        // ุฅุฑุณุงู ุทูุจ POST ูุชุบููุฑ ุงูุตูุงุญูุฉ
                        fetch(url, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ is_checked: isChecked })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.message) {
                                // ุนุฑุถ ุฑุณุงูุฉ ุจุณูุทุฉ
                                console.log(data.message);
                                // ูุง ุชุญุชุงุฌ ุฅูู ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉุ ููู ูููู ุชุญุฏูุซ ุดุฑูุท ุงูุฑุณุงุฆู
                                // ูู ุชุทุจูู Flask ุญููููุ ูุฌุจ ุชุญุฏูุซ ุฑุณุงุฆู ุงูููุงุด ุนุจุฑ AJAX
                                
                                // ุงูุชุฃูุฏ ูู ุญุงูุฉ ุงููุฑุจุน ุจูุงุกู ุนูู ุงูุฑุฏ
                                this.checked = data.new_state;
                            } else {
                                // ุฅุฐุง ูุดู ุงูุทูุจุ ุฃุนุฏ ุงูุญุงูุฉ ุงูุฃุตููุฉ ูููุฑุจุน
                                this.checked = !isChecked;
                                alert("ูุดู ุชุญุฏูุซ ุงูุตูุงุญูุฉ: " + data.message);
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            this.checked = !isChecked; // ุฅุนุงุฏุฉ ุงูุญุงูุฉ ุงูุฃุตููุฉ ุนูุฏ ุงููุดู
                            alert("ุญุฏุซ ุฎุทุฃ ูู ุงูุงุชุตุงู ุจุงูุฎุงุฏู.");
                        });
                    });
                }
            });
        });
    </script>
</body>
</html>
