<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØªØ¬Ø±</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* ... (ØªÙ†Ø³ÙŠÙ‚Ø§Øª CSS Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© ÙƒÙ…Ø§ Ù‡ÙŠ) ... */
        .admin-section {
            background: white;
            padding: 20px;
            margin-bottom: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        /* ... (Ø£Ø¶Ù Ø£ÙŠ ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ù‡Ù†Ø§) ... */
    </style>
</head>
<body>
    <header class="admin-header">
        <h1>Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØªØ¬Ø±</h1>
        <div>
            <span style="color: white; margin-left: 15px;">Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ {{ session.get('username', 'Ù…Ø´Ø±Ù') }}</span>
            <a href="{{ url_for('home') }}" class="admin-link">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…ØªØ¬Ø±</a>
            <a href="{{ url_for('admin_logout') }}">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a>
            <span style="margin-left:12px;">
                <label for="currency-select-admin" style="color:white;">Ø¹Ù…Ù„Ø©:</label>
                <select id="currency-select-admin" style="margin-left:6px;">
                    <option value="USD" {% if current_currency() == 'USD' %}selected{% endif %}>USD</option>
                    <option value="SAR" {% if current_currency() == 'SAR' %}selected{% endif %}>Ø±ÙŠØ§Ù„</option>
                </select>
            </span>
        </div>
    </header>

    <main>
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="message-{{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <section class="admin-section">
            <a href="{{ url_for('manage_admins') }}" class="admin-link" style="margin-bottom:15px;display:inline-block;">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ†</a>
        </section>

        <section class="admin-section dashboard-stats">
            <div class="stat-card">
                <h3>ğŸ’° Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©</h3>
                <p id="stats-total-sales">{{ format_price(stats.total_sales) }}</p>
            </div>
            <div class="stat-card">
                <h3>ğŸ”” Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</h3>
                <p style="color: {% if stats.new_orders_count > 0 %}#ffc107{% else %}#28a745{% endif %};">
                    {{ stats.new_orders_count }}
                </p>
            </div>
            <div class="stat-card {% if stats.low_stock_count > 0 %}alert{% endif %}">
                <h3>âš ï¸ Ù…Ù†ØªØ¬Ø§Øª Ù‚Ù„ÙŠÙ„Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</h3>
                <p>{{ stats.low_stock_count }}</p>
            </div>
        </section>

        <section class="admin-section">
            <h2>Ø±Ø³Ù… Ø¨ÙŠØ§Ù†ÙŠ Ù„Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ©</h2>
            <canvas id="salesChart" width="600" height="300"></canvas>
            <script>
                const salesLabels = {{ stats.sales_labels|tojson }};
                const salesData = {{ stats.sales_data|tojson }};
                const ctx = document.getElementById('salesChart').getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: salesLabels,
                        datasets: [{
                            label: 'Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª (Ø¬Ù†ÙŠÙ‡)',
                            data: salesData,
                            backgroundColor: 'rgba(54, 162, 235, 0.5)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            </script>
        </section>
        </section>

        {% if low_stock_products %}
        <section class="admin-section" style="background-color: #fff3cd; border: 1px solid #ffeeba; color: #856404;">
            <h3>ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…Ù†Ø®ÙØ¶</h3>
            <p>Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ© ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ø¥Ø¹Ø§Ø¯Ø© ØªØ²ÙˆÙŠØ¯ Ø¨Ø§Ù„Ù…Ø®Ø²ÙˆÙ† (Ø§Ù„Ù…Ø®Ø²ÙˆÙ† 5 Ø£Ùˆ Ø£Ù‚Ù„):</p>
            <ul>
                {% for product in low_stock_products %}
                    <li>**{{ product.name }}** (Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: {{ product.stock }})</li>
                {% endfor %}
            </ul>
        </section>
        {% endif %}

        <hr>

        <section class="admin-section">
            <h2>ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</h2>
            <form method="POST" action="{{ url_for('change_admin_password') }}" style="display: flex; flex-direction: column; gap: 10px; max-width: 400px;">
                <input type="password" name="old_password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©" required>
                <input type="password" name="new_password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©" required>
                <input type="password" name="confirm_password" placeholder="ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©" required>
                <button type="submit">ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</button>
            </form>
        </section>

        {% if permissions.admins %}
        <section class="admin-section">
            <h2>ğŸ‘¤ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ† ÙˆØ§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª</h2>
            
            <h3>Ø¥Ø¶Ø§ÙØ© Ù…Ø´Ø±Ù Ø¬Ø¯ÙŠØ¯</h3>
            <form method="POST" action="{{ url_for('add_admin') }}" style="display: flex; flex-direction: column; gap: 10px; padding: 15px; border: 1px dashed #ccc; margin-bottom: 20px;">
                <input type="text" name="username" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±Ù Ø§Ù„Ø¬Ø¯ÙŠØ¯" required style="padding: 10px;">
                <input type="password" name="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" required style="padding: 10px;">
                
                <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-top: 10px;">
                    <label><input type="checkbox" name="products"> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</label>
                    <label><input type="checkbox" name="orders"> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</label>
                    <label><input type="checkbox" name="reviews"> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</label>
                    <label><input type="checkbox" name="admins"> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ† (ÙƒØ§Ù…Ù„ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª)</label>
                </div>

                <button type="submit" style="background-color: #007bff; color: white;">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø´Ø±Ù</button>
            </form>
            
            <h3>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ† Ø§Ù„Ø­Ø§Ù„ÙŠÙŠÙ†</h3>
            <table>
                <thead>
                    <tr>
                        <th>Ø§Ù„Ø§Ø³Ù…</th>
                        <th>Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</th>
                        <th>Ø§Ù„Ø·Ù„Ø¨Ø§Øª</th>
                        <th>Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</th>
                        <th>Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ†</th>
                        <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th>
                    </tr>
                </thead>
                <tbody>
                    {% for admin in admin_users %}
                    <tr>
                        <td>{{ admin.username }} {% if admin.id == session.get('admin_id') %}(Ø£Ù†Øª){% endif %}</td>
                        <td>
                            <input type="checkbox" class="perm-checkbox" data-user-id="{{ admin.id }}" data-perm-type="products" {% if admin.can_manage_products %}checked{% endif %} {% if admin.id == session.get('admin_id') %}disabled{% endif %}>
                        </td>
                        <td>
                            <input type="checkbox" class="perm-checkbox" data-user-id="{{ admin.id }}" data-perm-type="orders" {% if admin.can_manage_orders %}checked{% endif %} {% if admin.id == session.get('admin_id') %}disabled{% endif %}>
                        </td>
                        <td>
                            <input type="checkbox" class="perm-checkbox" data-user-id="{{ admin.id }}" data-perm-type="reviews" {% if admin.can_manage_reviews %}checked{% endif %} {% if admin.id == session.get('admin_id') %}disabled{% endif %}>
                        </td>
                        <td>
                            <input type="checkbox" class="perm-checkbox" data-user-id="{{ admin.id }}" data-perm-type="admins" {% if admin.can_manage_admins %}checked{% endif %} {% if admin.id == session.get('admin_id') %}disabled{% endif %}>
                        </td>
                        <td>
                            {% if admin.id != session.get('admin_id') %}
                                <button style="background-color: #dc3545; padding: 6px 10px; opacity: 0.5;" disabled>Ø­Ø°Ù</button>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </section>
        <hr>
        {% endif %}
        {% if permissions.products %}
        <section class="admin-section">
            <h2>â• Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯</h2>
            <form method="POST" action="{{ url_for('add_product') }}" enctype="multipart/form-data">
                
                <div class="form-container" style="box-shadow: none;">
                    <label for="name">Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬:</label>
                    <input type="text" id="name" name="name" required>
                    <label for="price">Ø§Ù„Ø³Ø¹Ø± ($):</label>
                    <input type="number" id="price" name="price" step="0.01" required>

                    <label for="stock">Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†:</label>
                    <input type="number" id="stock" name="stock" required>
                    
                    <label for="category_id">Ø§Ù„ÙØ¦Ø©:</label>
                    <select id="category_id" name="category_id" required>
                        {% for category in categories %}
                            <option value="{{ category.id }}">{{ category.name }}</option>
                        {% endfor %}
                    </select>

                    <label for="image_file">ØªØ­Ù…ÙŠÙ„ ØµÙˆØ±Ø© Ø§Ù„Ù…Ù†ØªØ¬:</label>
                    <input type="file" id="image_file" name="image_file" accept=".png, .jpg, .jpeg, .gif">

                    <label for="description">Ø§Ù„ÙˆØµÙ:</label>
                    <textarea id="description" name="description"></textarea>
                    
                    <button type="submit">Ø£Ø¶Ù Ø§Ù„Ù…Ù†ØªØ¬</button>
                </div>
            </form>
        </section>
        <hr>
        {% endif %}

        {% if permissions.products %}
        <section class="admin-section">
            <h2>ğŸ›’ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© ({{ products|length }})</h2>
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Ø§Ù„ØµÙˆØ±Ø©</th>
                        <th>Ø§Ù„Ø§Ø³Ù…</th>
                        <th>Ø§Ù„Ø³Ø¹Ø±</th>
                        <th>Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</th>
                        <th>Ø§Ù„ÙØ¦Ø©</th>
                        <th>Ù…ØªÙˆØ³Ø· Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</th>
                        <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                    </tr>
                </thead>
                <tbody>
                    {% for product in products %}
                        <tr>
                            <td>{{ product.id }}</td>
                            <td><img src="{{ product.image_url }}" alt="{{ product.name }}" onerror="this.src='/static/placeholder.png'"></td>
                            <td>{{ product.name }}</td>
                            <td class="product-price" data-product-id="{{ product.id }}">{{ format_price(product.price) }}</td>
                            <td style="color: {% if product.stock <= 5 %}red; font-weight: bold;{% endif %}">{{ product.stock }}</td>
                            <td>{{ product.category.name if product.category else 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}</td>
                            
                            <td>
                                {% set rating_info = product.get_rating_info() %}
                                {% if rating_info.count > 0 %}
                                    <span class="rating-display">
                                        {{ rating_info.average | round(2) }} â­
                                    </span>
                                    ({{ rating_info.count }})
                                {% else %}
                                    Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªÙ‚ÙŠÙŠÙ…
                                {% endif %}
                            </td>
                            
                            <td class="action-btns">
                                <a href="{{ url_for('edit_product', product_id=product.id) }}" style="background-color: #ffc107; color: #333;">ØªØ¹Ø¯ÙŠÙ„</a>
                                
                                <form method="POST" action="{{ url_for('delete_product', product_id=product.id) }}" onsubmit="return confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ {{ product.name }}ØŸ');">
                                    <button type="submit" style="background-color: #dc3545;">Ø­Ø°Ù</button>
                                </form>
                                
                                <form method="POST" action="{{ url_for('reset_product_reviews', product_id=product.id) }}" onsubmit="return confirm('ØªØ­Ø°ÙŠØ±! Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ ØªÙ‚ÙŠÙŠÙ…Ø§Øª {{ product.name }}ØŸ');" style="display: inline;">
                                    <button type="submit" style="background-color: #ff9800; color: white;">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</button>
                                </form>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </section>
        <hr>
        {% endif %}

        {% if permissions.reviews %}
        <section class="admin-section">
            <h2>â­ Ø¥Ø¯Ø§Ø±Ø© ÙˆÙ…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª ({{ all_reviews|length }})</h2>
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
                        <th>Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</th>
                        <th>Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹</th>
                        <th>Ø§Ù„ØªØ¹Ù„ÙŠÙ‚</th>
                        <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                        <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th>
                    </tr>
                </thead>
                <tbody>
                    {% for review in all_reviews %}
                        <tr>
                            <td>{{ review.id }}</td>
                            <td><a href="{{ url_for('product_detail', product_id=review.product_id) }}" target="_blank">{{ review.product.name }}</a></td>
                            <td>
                                <span class="rating-display">
                                    {% for i in range(review.rating) %}â˜…{% endfor %}
                                </span>
                                ({{ review.rating }}/5)
                            </td>
                            <td>{{ review.reviewer_name }}</td>
                            <td class="review-comment">{{ review.comment or '---' }}</td>
                            <td>{{ review.date_posted.strftime('%Y-%m-%d') }}</td>
                            <td>
                                <form method="POST" action="{{ url_for('delete_review', review_id=review.id) }}" onsubmit="return confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…ØŸ');">
                                    <button type="submit" style="background-color: #dc3545;">Ø­Ø°Ù</button>
                                </form>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </section>
        <hr>
        {% endif %}

        {% if permissions.products %}
        <section class="admin-section">
            <h2>ğŸ·ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙØ¦Ø§Øª</h2>
            <form method="POST" action="{{ url_for('add_category') }}" style="display: flex; gap: 10px; margin-bottom: 20px;">
                <input type="text" name="name" placeholder="Ø§Ø³Ù… Ø§Ù„ÙØ¦Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©" required style="flex-grow: 1; padding: 10px;">
                <button type="submit">Ø¥Ø¶Ø§ÙØ© ÙØ¦Ø©</button>
            </form>
            
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Ø§Ù„Ø§Ø³Ù…</th>
                        <th>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</th>
                        <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th>
                    </tr>
                </thead>
                <tbody>
                    {% for category in categories %}
                        <tr>
                            <td>{{ category.id }}</td>
                            <td>{{ category.name }}</td>
                            <td>{{ category.products|length }}</td>
                            <td>
                                <form method="POST" action="{{ url_for('delete_category', category_id=category.id) }}" style="display: inline;" onsubmit="return confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„ÙØ¦Ø©ØŸ');">
                                    <button type="submit" style="background-color: #dc3545;">Ø­Ø°Ù</button>
                                </form>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </section>
        <hr>
        {% endif %}

        {% if permissions.orders %}
        <section class="admin-section">
            <h2>ğŸ“¦ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø­Ø¯ÙŠØ«Ø© ({{ orders|length }})</h2>
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                        <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ ($)</th>
                        <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                        <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                        <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                    </tr>
                </thead>
                <tbody>
                    {% for order in orders %}
                        <tr>
                            <td>{{ order.id }}</td>
                            <td>{{ order.customer_name }}</td>
                            <td class="order-total" data-order-id="{{ order.id }}">{{ format_price(order.total_price) }}</td>
                            <td>{{ order.date_placed.strftime('%Y-%m-%d %H:%M') }}</td>
                            <td>
                                <form method="POST" action="{{ url_for('update_order_status', order_id=order.id) }}" style="display: inline;">
                                    <select name="status" onchange="this.form.submit()">
                                        <option value="New" {% if order.status == 'New' %}selected{% endif %}>Ø¬Ø¯ÙŠØ¯</option>
                                        <option value="Processing" {% if order.status == 'Processing' %}selected{% endif %}>Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©</option>
                                        <option value="Shipped" {% if order.status == 'Shipped' %}selected{% endif %}>ØªÙ… Ø§Ù„Ø´Ø­Ù†</option>
                                        <option value="Delivered" {% if order.status == 'Delivered' %}selected{% endif %}>ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…</option>
                                    </select>
                                </form>
                            </td>
                            <td>
                                <a href="{{ url_for('order_details', order_id=order.id) }}" style="background-color: #17a2b8;">ØªÙØ§ØµÙŠÙ„</a>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </section>
        <hr>
        {% endif %}
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const checkboxes = document.querySelectorAll('.perm-checkbox');
            
            checkboxes.forEach(checkbox => {
                if (!checkbox.disabled) { // Ù„Ø§ ØªØ´ØºÙ„ Ø§Ù„Ù…Ø³ØªÙ…Ø¹ Ù„Ù„Ù…Ø´Ø±Ù Ø§Ù„Ø­Ø§Ù„ÙŠ
                    checkbox.addEventListener('change', function() {
                        const userId = this.getAttribute('data-user-id');
                        const permType = this.getAttribute('data-perm-type');
                        const isChecked = this.checked;
                        
                        const url = `/admin/permission/toggle/${userId}/${permType}`;
                        
                        // Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ POST Ù„ØªØºÙŠÙŠØ± Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©
                        fetch(url, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ is_checked: isChecked })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.message) {
                                // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø¨Ø³ÙŠØ·Ø©
                                console.log(data.message);
                                // Ù„Ø§ ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©ØŒ Ù„ÙƒÙ† ÙŠÙ…ÙƒÙ† ØªØ­Ø¯ÙŠØ« Ø´Ø±ÙŠØ· Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
                                // ÙÙŠ ØªØ·Ø¨ÙŠÙ‚ Flask Ø­Ù‚ÙŠÙ‚ÙŠØŒ ÙŠØ¬Ø¨ ØªØ­Ø¯ÙŠØ« Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ÙÙ„Ø§Ø´ Ø¹Ø¨Ø± AJAX
                                
                                // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø±Ø¨Ø¹ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø¯
                                this.checked = data.new_state;
                            } else {
                                // Ø¥Ø°Ø§ ÙØ´Ù„ Ø§Ù„Ø·Ù„Ø¨ØŒ Ø£Ø¹Ø¯ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ© Ù„Ù„Ù…Ø±Ø¨Ø¹
                                this.checked = !isChecked;
                                alert("ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©: " + data.message);
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            this.checked = !isChecked; // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ© Ø¹Ù†Ø¯ Ø§Ù„ÙØ´Ù„
                            alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….");
                        });
                    });
                }
            });
        });
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function(){
            const sel = document.getElementById('currency-select-admin');
            if(!sel) return;
            sel.addEventListener('change', async function(){
                const code = sel.value;
                try{
                    // set session currency via AJAX
                    await fetch(`/set_currency/${code}?ajax=1`, { method: 'GET' });

                    // fetch updated pricing data for admin UI
                    const resp = await fetch('/admin/pricing_data');
                    if (!resp.ok) {
                        throw new Error('Failed to fetch pricing data');
                    }
                    const data = await resp.json();

                    // update stats
                    if (data.stats && data.stats.total_sales_display) {
                        const el = document.getElementById('stats-total-sales');
                        if (el) el.textContent = data.stats.total_sales_display;
                    }

                    // update product prices
                    if (Array.isArray(data.products)) {
                        data.products.forEach(p => {
                            const cell = document.querySelector(`.product-price[data-product-id="${p.id}"]`);
                            if (cell) cell.textContent = p.price_display;
                        });
                    }

                    // update order totals
                    if (Array.isArray(data.orders)) {
                        data.orders.forEach(o => {
                            const cell = document.querySelector(`.order-total[data-order-id="${o.id}"]`);
                            if (cell) cell.textContent = o.total_display;
                        });
                    }

                }catch(e){
                    console.error(e);
                    // fallback to reload on error
                    window.location.reload();
                }
            });
        });
    </script>
</body>
</html>
